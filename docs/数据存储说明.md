# 数据存储说明

## 📁 存储位置

NetTLS Route Manager 所有数据都存储在程序目录下，方便备份和迁移。

### 1. Profile 配置文件

**位置：** `profiles/`

每个 Profile 是一个 JSON 文件，包含：
- 路由配置列表
- 接口策略
- 默认参数
- 验证设置

**示例：** `profiles/home.json`

```json
{
  "version": 1,
  "profileName": "home",
  "created": "2025-11-12T09:12:24",
  "lastModified": "2025-11-12T21:44:47",
  "defaults": {
    "metric": 5,
    "persistent": true,
    "verify": {
      "routeHit": true,
      "trace": false,
      "timeoutMs": 1500
    }
  },
  "interfacePolicy": {
    "physical": {
      "nameMatch": "",
      "gateway": "",
      "mac": ""
    },
    "wireguard": {
      "nameMatch": "client",
      "fullTunnelGuard": true
    }
  },
  "routes": [
    {
      "enabled": true,
      "target": "39.104.63.75",
      "prefix_length": 32,
      "gateway": "192.168.1.1",
      "interface_name": "vEthernet (mychange)",
      "metric": 1,
      "persistent": true,
      "pin": false,
      "group": "aliyun",
      "desc": "阿里云服务器"
    }
  ],
  "pinned": {}
}
```

### 2. 快照目录

**位置：** `snapshots/`

存储系统路由快照和配置快照：
- `system-routes-YYYYMMDD-HHMMSS.json` - 系统路由快照
- `app-config-{profile}-YYYYMMDD-HHMMSS.json` - 配置快照

快照用于回滚功能，在应用路由前自动创建。

### 3. 日志文件

**位置：** `logs/rtmgr.log`

记录程序运行日志，包括：
- 路由操作记录
- 错误信息
- 系统事件

日志自动轮转，避免文件过大。

## 🔄 备份与迁移

### 备份方法

1. **完整备份**
   ```
   复制整个程序目录即可
   ```

2. **仅备份配置**
   ```
   复制 profiles/ 目录
   ```

3. **导出单个 Profile**
   - 在程序中使用 "Profile 管理" → "导出"
   - 或直接复制对应的 JSON 文件

### 迁移步骤

1. 将备份的 `profiles/` 目录复制到新的程序目录
2. 启动程序，会自动识别所有 Profile
3. 如需恢复快照，将 `snapshots/` 目录也一并复制

## 🛡️ 数据安全

### 自动保护机制

- ✅ 每次应用路由前自动创建快照
- ✅ 配置修改时自动保存
- ✅ 支持回滚到历史快照
- ✅ 导入导出支持 JSON 和 CSV 格式

### 手动保护建议

1. **定期备份**
   - 建议每周备份一次 `profiles/` 目录
   - 重要操作前手动创建快照

2. **版本控制**
   - 可以将 `profiles/` 目录加入 Git 管理
   - 方便跟踪配置变更历史

3. **异地备份**
   - 将配置文件同步到云盘
   - 使用导出功能保存关键配置

## 📊 数据结构

### Route 对象

```python
{
  "enabled": bool,          # 是否启用
  "target": str,            # 目标 IP
  "prefix_length": int,     # 前缀长度 (0-32)
  "gateway": str,           # 网关 IP
  "interface_name": str,    # 接口名称
  "metric": int,            # 路由优先级
  "persistent": bool,       # 是否持久化
  "pin": bool,             # 是否固定
  "group": str,            # 分组名称
  "desc": str,             # 描述信息
  "if_index": int,         # 接口索引 (自动填充)
  "last_apply_result": str,# 最后应用结果
  "last_apply_time": str   # 最后应用时间
}
```

### 配置版本

当前配置版本：**v1**

未来版本更新时，程序会自动迁移旧版本配置。

## ❓ 常见问题

### Q: 如何重置配置？

A: 删除 `profiles/` 目录下的对应 JSON 文件，程序会自动创建默认配置。

### Q: 快照文件可以删除吗？

A: 可以。快照仅用于回滚，删除不影响当前配置。建议保留最近的几个快照。

### Q: 如何在多台电脑间同步配置？

A: 使用以下方法之一：
1. 将 `profiles/` 目录放在云盘同步文件夹中
2. 使用 Git 管理配置文件
3. 定期导出/导入 Profile

### Q: 数据存储是否安全？

A: 所有数据都存储在本地，不涉及网络传输。JSON 格式便于查看和编辑。建议定期备份重要配置。

## 🔧 高级用法

### 1. 手动编辑配置

配置文件是标准 JSON 格式，可以用文本编辑器直接编辑。

**注意：**
- 编辑前先备份
- 确保 JSON 格式正确
- 程序运行时不要编辑

### 2. 批量导入

使用 CSV 格式批量导入路由：

```csv
enabled,target,prefix_length,gateway,interface_name,metric,persistent,group,desc
true,8.8.8.8,32,192.168.1.1,以太网,5,true,dns,Google DNS
true,1.1.1.1,32,192.168.1.1,以太网,5,true,dns,Cloudflare DNS
```

### 3. 配置模板

创建配置模板方便快速部署：

1. 创建标准配置 Profile
2. 导出为 JSON
3. 在新环境中导入
4. 根据实际情况调整接口名称和网关

## 📞 技术支持

如遇到数据相关问题，请查看：
- 日志文件：`logs/rtmgr.log`
- 用户手册：`docs/USER_GUIDE.md`
- 设计文档：`docs/设计文档.md`

---

**最后更新：** 2025-11-12  
**文档版本：** 1.0

