# 1. 产品定位与目标

* **定位**：Windows 11 上的本地 GUI 工具，用于**查看/新增/删除/修改/应用**永久（persistent）IPv4 路由，并为每条路由提供**描述信息**与分组管理。
* **目标**：覆盖日常“直连白名单”维护；避免手工 `route add` 的易错与 ifIndex 漂移问题；一键“应用/回滚”；轻量易部署（单文件最佳）。

# 2. 技术路线（建议）

* **实现语言/框架**：

  * 首选 **Python + PyQt6**（你之前已提过，开发快、打包简便）。
  * 调用层用 **PowerShell/route.exe** 与 **netsh**，早期不碰 WinAPI，降低复杂度。
  * 打包：`PyInstaller --onefile --noconsole`。
* **权限**：操作永久路由需要管理员权限。程序启动时自检；若不是管理员，提示“以管理员身份运行”。

# 3. 核心功能清单

1. **路由列表视图**

   * 列：启用(✔/✖)、目标(支持 IP/CIDR/域名)、掩码(只读或自动算出)、网关、接口(显示接口名)、Metric、持久(默认持久)、描述、所属分组、最近一次应用结果/时间。
   * 支持**过滤/搜索**（按目标/描述/分组）。
   * 支持**多选**（批量启用/禁用/删除/应用）。
2. **新增/编辑路由**

   * 目标：支持 **IPv4 /32 /CIDR**；支持**域名**（解析成 A 记录；可“固定解析（pin）”）。
   * 网关：默认读取“被选接口”的网关；允许手填；表单校验“网关同子网”。
   * 接口：用**接口名**选择（如 `vEthernet (mychange)`），保存时不写死 ifIndex，应用时**动态解析** ifIndex。
   * Metric：默认值（如 5），可改。
   * 描述：必填或选填（建议必填，便于审计）。
   * 选项：`持久(Persistent)`（默认勾选）、`固定解析(Pin)`、`验证连通性`（tracert/首跳）。
3. **一键应用（Apply）**

   * 根据“当前系统永久路由”与“配置”做 **Diff**：新增/变更/删除清单 → 执行计划 → 执行 → 结果反馈。
   * **幂等**：对已有且一致的条目跳过。
   * **事务式回滚**：执行失败时按步骤回滚至应用前快照。
4. **验证（Verify）**

   * 逐条或批量：`route print <dst>` 命中检查 → 解析出出接口 → 可选 `Test-NetConnection -TraceRoute` 看第一跳是否为目标网关（如 192.168.1.1）。
   * 显示验证结果与耗时。
5. **接口与环境管理**

   * 读取所有“Up”接口（显示：接口名、ifIndex、MAC、网段、默认网关）。
   * 可设置**默认物理接口**（用于批量新增时自动带出网关）。
   * **WireGuard 检测**（是否存在名为 `client` 的适配器、是否存在 `0.0.0.0/1` 与 `128.0.0.0/1`）。若存在，UI 给予提示“你处于全隧道环境，建议将直连白名单设置为 /32 或精确 CIDR”。
6. **Profile（场景）管理**

   * 多配置文件（如 `home.json`、`office.json`）。
   * 支持**切换/导入/导出**；切换后可选择“立即应用”或“仅载入编辑态”。
7. **审计与快照**

   * 每次应用前自动生成 **系统永久路由快照** 与**工具配置快照**。
   * 审计日志：时间、用户、变更明细（新增/修改/删除）、命令、返回码。
   * 提供“回滚至上次快照”按钮。
8. **批量导入导出**

   * 支持 CSV/JSON 导入导出（便于维护与分享白名单）。
   * 导入时做字段校验与预检查。
9. **安全护栏**

   * 阻止对**本地子网/Loopback/默认路由**的危险修改（可在设置里允许高级模式）。
   * 阻止添加与现有系统默认网关冲突/无效网关的路由。

# 4. 数据结构与存储

* 应用层配置（JSON）：

```json
{
  "version": 1,
  "profileName": "home",
  "defaults": {
    "metric": 5,
    "persistent": true,
    "verify": { "routeHit": true, "trace": false, "timeoutMs": 1500 }
  },
  "interfacePolicy": {
    "physical": { "nameMatch": "vEthernet (mychange)", "gateway": "192.168.1.1", "mac": "" },
    "wireguard": { "nameMatch": "client", "fullTunnelGuard": true }
  },
  "routes": [
    {
      "enabled": true,
      "target": "39.96.205.182/32",     // 也可写 "git.example.com"
      "gateway": "",                    // 为空则自动使用 physical.gateway
      "interfaceName": "vEthernet (mychange)",
      "metric": 3,
      "persistent": true,
      "pin": false,                     // target 为域名时有效
      "group": "aliyun",
      "desc": "阿里云A"
    }
  ],
  "pinned": {                           // 仅域名 pin 生效时落盘
    "git.example.com": ["8.8.8.8", "8.8.4.4"]
  }
}
```

* 运行态缓存：最近一次 DNS 解析结果、接口名→ifIndex 映射。
* 快照：`snapshots/system-routes-YYYYMMDD-HHMMSS.json`、`snapshots/app-config-YYYYMMDD-HHMMSS.json`
* 审计：`logs/rtmgr.log`（滚动分片）。

# 5. 关键流程（时序）

**Apply 按钮 →**

1. 读取当前接口状态（`Get-NetAdapter` / `netsh interface ip show interfaces`）；
2. 解析配置：域名目标做 DNS 解析（可 pin），补全网关、ifIndex；
3. 读取“系统永久路由”表（`route print -4` + 解析 或 `Get-NetRoute -AddressFamily IPv4`）；
4. 生成 Diff（add/change/delete），展示预览对话框（Dry-run）；
5. 执行计划：

   * `delete`（先删冲突项）
   * `change`（网关/metric/ifIndex）
   * `add`（`route -p add ...`）
   * 任一步失败 → 回滚；
6. 验证：对标记“需要验证”的项做命中检查与 TraceRoute；
7. 写入快照与审计日志；UI 标记成功/失败状态。

# 6. UI 草图（简洁）

* **顶部工具栏**：Profile 下拉 | 读取接口按钮 | 应用 | 验证 | 回滚 | 导入 | 导出 | 设置 | 帮助
* **左侧**：分组树（All、未分组、按 group）
* **右侧**：路由表格（可编辑列）
  列：启用 | 目标 | 掩码(只读) | 网关 | 接口名(下拉) | Metric | 持久 | 描述 | 结果
* **底部状态栏**：当前物理接口/网关、WireGuard 检测状态、上次应用时间与结果
* **弹窗**：

  * 新建/编辑路由对话框
  * Diff 预览/确认对话框
  * 验证结果详情（含首跳/时延）

# 7. 与系统交互（命令封装）

> 早期直接调命令最稳，后续可替换为 WinAPI。

* 列出接口（JSON 输出便于解析）：

  * `powershell -Command "Get-NetAdapter | Where-Object {$_.Status -eq 'Up'} | Select Name,ifIndex,MacAddress | ConvertTo-Json"`
* 列出当前路由：

  * `powershell -Command "Get-NetRoute -AddressFamily IPv4 | ConvertTo-Json"`
  * 或解析 `route print -4`（兼容性更广）
* 新增永久路由：

  * `cmd /c route -p add <ip> mask <netmask> <gateway> IF <ifIndex> metric <metric>`
* 修改：

  * `cmd /c route change <ip> mask <netmask> <gateway> IF <ifIndex> metric <metric>`
* 删除：

  * `cmd /c route delete <ip>`
* 命中检查：

  * `cmd /c route print <ip>`
* 验证：

  * `powershell -Command "Test-NetConnection <ip> -TraceRoute -InformationLevel Detailed"`

> **注意**：尽量**不写死 IF**。若能唯一识别网关所在接口，可省略 `IF` 让系统自动匹配；但为了可控，UI 默认还是按接口名→ifIndex 映射填充 `IF`。

# 8. 表单校验与规则

* 目标校验：

  * IPv4：校验合法性与 CIDR 范围（1–32）；
  * 域名：允许 FQDN，解析失败提示且禁止应用（除非 pin 有缓存）。
* 掩码自动化：CIDR→掩码；/32 强制 Host 路由。
* 网关校验：**必须与所选接口在同一网段**（通过接口 IP/掩码计算验证）。
* Metric：1–999，默认 5（可在设置里配置）。
* 冲突检测：

  * 与本地子网/默认路由冲突 → 禁止（可在“高级模式”打开后放行）。
  * 与现存永久路由重复 → 走 change 分支而不是 add。

# 9. 错误处理与回滚策略

* 执行时为每条操作记录“反向操作”（add→delete；change→change 回原值；delete→add 原值）。
* 任一步失败：按 LIFO 逐步回滚。
* UI 记录失败条目、错误输出（标准输出/标准错误），并提示“查看日志”。

# 10. 非功能需求

* **性能**：千级路由条目在 3–5 秒完成 Diff；应用取决于系统命令速度（并行度可配置，默认串行保证安全）。
* **可移植**：Win10/11 x64；管理员权限要求；离线可用。
* **日志**：文件轮转，默认 5MB × 5 份。

# 11. 开发里程碑（建议）

* M1（1–2 天）：项目脚手架、接口枚举、路由读取、基础表格展示；
* M2（2–3 天）：新增/编辑/删除、表单校验、Diff 预览、基础 Apply；
* M3（2 天）：验证链（route print/trace）、快照/回滚、审计日志；
* M4（1–2 天）：Profile/导入导出、分组与搜索、WireGuard 提示；
* M5（1 天）：打包发布、管理员自检、崩溃日志、边界测试。

# 12. 关键实现细节（算法/工具函数）

* **CIDR → 掩码**：`mask = ((1<<n)-1) << (32-n)` 再转 IPv4 字符串；
* **同网段校验**：`(ip & mask) == (gateway & mask)`；
* **接口名 → ifIndex**：缓存映射；变化时（适配器增删）自动刷新；
* **域名解析**：`socket.getaddrinfo(host, None, family=AF_INET)`；若 `pin=true` 将解析结果落盘并优先使用固定 IP；
* **Diff 规则**：以 `<dstPrefix, gateway, interfaceName, metric, persistent>` 为键比对；仅目标/接口名/网关/metric 改变走 `change`，删除走 `delete`，新增走 `add`；
* **WireGuard 全隧道提示**：检测到 `/1` 路由时，在新增弹窗和列表顶部显示“当前是全隧道，建议使用 /32 或精确段”。

# 13. 示例：CSV/JSON 导入格式

* CSV 列：`enabled,target,gateway,interfaceName,metric,persistent,pin,group,desc`
* JSON 同第 4 节结构。

# 14. 最小可用命令拼装（示例伪码）

```python
def apply_route_add(dst_ip, cidr, gw, ifname, metric):
    mask = cidr_to_mask(cidr)
    ifindex = resolve_ifindex(ifname)
    cmd = f'route -p add {dst_ip} mask {mask} {gw} IF {ifindex} metric {metric}'
    return run_cmd(cmd)  # 捕获返回码与stderr

def verify_first_hop(dst_ip):
    # 备用：仅 route print 命中检查
    return run_cmd(f'route print {dst_ip}')
```

# 15. 测试清单（要点）

* 正常场景：/32 与 /24 新增→应用→验证→修改 metric→验证→删除→回滚；
* ifIndex 漂移：禁用/启用接口、重启 WireGuard 适配器后再次应用（应仍成功）；
* 网关不在同网段：应被前端拦截；
* 域名 pin：首次解析→断网→再次应用（应使用 pinned IP）；
* 与全隧道并存：未列白名单的 IP 走 WG，白名单走物理，验证首跳正确。

