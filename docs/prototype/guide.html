<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>路由管理工具原型说明</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
  <header class="page-hero">
    <div class="hero-content">
      <h1>路由管理工具原型说明</h1>
      <p>本页汇总功能概览、关键流程、数据结构、交互细节以及实现建议，配合 <code>index.html</code> 交互原型共同使用。</p>
      <div class="hero-tags">
        <span class="tag">功能说明</span>
        <span class="tag">流程图</span>
        <span class="tag">数据映射</span>
        <span class="tag">实现建议</span>
      </div>
      <div style="margin-top:1.5rem;">
        <a class="btn primary" href="index.html">返回交互原型</a>
      </div>
    </div>
  </header>

  <main>
    <section class="section-card">
      <h2>弹窗与面板概览</h2>
      <p>以下为主要弹窗与面板功能摘要，交互演示可在 <code>index.html</code> 中查看。</p>
      <div class="card-grid">
        <article class="card">
          <div>
            <h3>接口与环境</h3>
            <p>列出 Up 接口，设置默认物理接口，并提醒 WireGuard 全隧道状态。</p>
            <ul class="list">
              <li>显示接口名、ifIndex、MAC、网段、网关。</li>
              <li>支持一键刷新并提示权限问题。</li>
            </ul>
          </div>
        </article>
        <article class="card">
          <div>
            <h3>新增/编辑路由</h3>
            <p>支持 IPv4 / CIDR / 域名，自动填充掩码、网关与 Pin 设置。</p>
            <ul class="list">
              <li>表单校验网关与接口同网段。</li>
              <li>支持验证连通性与描述必填提醒。</li>
              <li>可选择单条 Apply 或加入批量计划。</li>
            </ul>
          </div>
        </article>
        <article class="card">
          <div>
            <h3>Diff 预览</h3>
            <p>执行前预览新增/修改/删除计划，支持失败自动回滚。</p>
            <ul class="list">
              <li>展示操作序列：删除 → 修改 → 新增。</li>
              <li>命令日志实时滚动，可复制。</li>
              <li>支持勾选自动验证与失败回滚。</li>
            </ul>
          </div>
        </article>
        <article class="card">
          <div>
            <h3>验证结果</h3>
            <p>结合 route print 与 TraceRoute 呈现命中结果、首跳与耗时。</p>
            <ul class="list">
              <li>支持批量验证与导出报告。</li>
              <li>失败项可一键重试。</li>
            </ul>
          </div>
        </article>
        <article class="card">
          <div>
            <h3>Profile 管理</h3>
            <p>维护多套场景配置，支持导入、导出与切换策略。</p>
            <ul class="list">
              <li>切换前可生成临时快照。</li>
              <li>可选择仅加载或立即 Apply。</li>
            </ul>
          </div>
        </article>
        <article class="card">
          <div>
            <h3>导入 / 导出</h3>
            <p>CSV / JSON 双格式，内置校验与冲突策略配置。</p>
            <ul class="list">
              <li>导入支持覆盖 / 追加 / 跳过。</li>
              <li>导出可包含 pinned DNS 与审计摘要。</li>
            </ul>
          </div>
        </article>
        <article class="card">
          <div>
            <h3>快照与回滚</h3>
            <p>Apply 前自动生成系统/配置快照，支持差异对比与回放。</p>
            <ul class="list">
              <li>记录操作人、摘要与结果。</li>
              <li>回滚使用反向命令 LIFO 执行。</li>
            </ul>
          </div>
        </article>
        <article class="card">
          <div>
            <h3>设置与安全护栏</h3>
            <p>配置默认参数、并发度、日志策略与风险防护。</p>
            <ul class="list">
              <li>阻止默认路由/本地子网危险修改。</li>
              <li>高级模式需二次确认。</li>
            </ul>
          </div>
        </article>
      </div>
    </section>

    <section class="section-card">
      <h2>核心功能概览</h2>
      <div class="feature-grid">
        <div class="feature-card">
          <h3>主工作台</h3>
          <ul>
            <li>顶部工具栏提供 Profile 切换、接口刷新、Apply、验证、回滚、导入导出、设置、帮助。</li>
            <li>分组树按 group 分类，支持右键管理与 WireGuard 风险提示。</li>
            <li>路由表格支持多选、过滤、内联编辑与结果列历史查看。</li>
          </ul>
        </div>
        <div class="feature-card">
          <h3>路由编辑</h3>
          <ul>
            <li>支持 IPv4、CIDR、域名；域名可 Pin 固定解析。</li>
            <li>自动计算掩码、网关同网段校验、Metric 默认值。</li>
            <li>可配置持久化、验证连通性、描述与分组。</li>
          </ul>
        </div>
        <div class="feature-card">
          <h3>Apply 与回滚</h3>
          <ul>
            <li>Diff 预览展示 add/change/delete/skip 清单。</li>
            <li>支持单条 Apply 或批量 Apply。</li>
            <li>失败时自动回滚至快照。</li>
          </ul>
        </div>
        <div class="feature-card">
          <h3>验证链路</h3>
          <ul>
            <li>命中检查：route print / Get-NetRoute。</li>
            <li>TraceRoute：Test-NetConnection 获取首跳与耗时。</li>
            <li>可导出验证报告，支持重试失败项。</li>
          </ul>
        </div>
        <div class="feature-card">
          <h3>Profile & 导入导出</h3>
          <ul>
            <li>多 Profile JSON 切换，支持导入导出和快照备份。</li>
            <li>CSV/JSON 导入校验字段、冲突策略可选。</li>
            <li>导出可过滤范围并包含 pinned DNS。</li>
          </ul>
        </div>
        <div class="feature-card">
          <h3>安全与日志</h3>
          <ul>
            <li>安全护栏阻止默认路由、本地子网危险修改。</li>
            <li>WireGuard 全隧道检测提醒使用 /32。</li>
            <li>日志滚动与快照保存，支持审计回溯。</li>
          </ul>
        </div>
      </div>
    </section>

    <section class="section-card">
      <h2>关键流程（Mermaid）</h2>
      <p>以下流程图覆盖 Apply、验证、快照回滚、Profile 切换、域名 Pin 等核心链路。</p>
      <div class="flow-grid">
        <div>
          <h3>Apply 执行</h3>
          <pre class="mermaid">
flowchart TD
    A[用户点击 应用] --> B[读取接口状态\nGet-NetAdapter]
    B --> C[解析配置\n域名解析/Pin 填充]
    C --> D[读取系统永久路由\nGet-NetRoute / route print]
    D --> E[生成 Diff 清单\n新增/修改/删除/跳过]
    E --> F{用户确认执行?}
    F -- 否 --> G[返回主界面]
    F -- 是 --> H[执行计划\n删除→修改→新增]
    H --> I{执行成功?}
    I -- 是 --> J[按需执行验证\nTest-NetConnection]
    J --> K[写入快照与审计日志]
    I -- 否 --> L[触发回滚\nLIFO 逆序执行]
    L --> M[显示失败总结并引导查看日志]
    K --> N[更新列表状态/时间戳]
    M --> N
          </pre>
        </div>
        <div>
          <h3>验证流程</h3>
          <pre class="mermaid">
flowchart TD
    A[选择路由 → 点击 验证] --> B[遍历待验证条目]
    B --> C[执行 route print <dst> 命中检查]
    C --> D{需要 Trace?}
    D -- 是 --> E[Test-NetConnection -TraceRoute]
    D -- 否 --> F[记录命中结果]
    E --> F
    F --> G[收集耗时/首跳信息]
    G --> H[更新列表结果列并汇总]
    H --> I[弹出验证结果弹窗]
          </pre>
        </div>
        <div>
          <h3>快照回滚</h3>
          <pre class="mermaid">
flowchart TD
    A[点击 回滚] --> B[选择目标快照]
    B --> C[提示影响并确认]
    C --> D[执行系统路由快照回放]
    D --> E[恢复应用配置快照]
    E --> F{执行成功?}
    F -- 是 --> G[更新状态栏并记录审计]
    F -- 否 --> H[提示失败并保留日志]
          </pre>
        </div>
        <div>
          <h3>Profile 切换</h3>
          <pre class="mermaid">
flowchart TD
    A[Profile 下拉选择] --> B[检测未保存修改?]
    B -- 是 --> C[提示创建临时快照或放弃改动]
    C --> D
    B -- 否 --> D[加载目标 Profile 配置]
    D --> E{选择立即应用?}
    E -- 是 --> F[调用 Apply 流程]
    E -- 否 --> G[仅更新编辑态数据表]
    F --> H[更新状态栏 Profile 名称]
    G --> H
          </pre>
        </div>
        <div>
          <h3>域名 Pin & 缓存</h3>
          <pre class="mermaid">
flowchart TD
    A[保存/Apply 包含域名路由] --> B{Pin 勾选?}
    B -- 否 --> C[实时解析 DNS 并缓存内存]
    B -- 是 --> D[解析 DNS 并写入 pinned 列表]
    D --> E[离线时使用 pinned IP]
    C --> F[Apply 时使用当前解析结果]
    E --> F
    F --> G[记录解析来源与时间戳]
          </pre>
        </div>
      </div>
    </section>

    <section class="section-card">
      <h2>数据结构与存储映射</h2>
      <table class="info-table">
        <thead>
          <tr>
            <th>数据项</th>
            <th>存储位置</th>
            <th>说明</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Profile 配置</td>
            <td><code>profiles/*.json</code>（默认 <code>home.json</code>）</td>
            <td>与设计文档 §4 结构一致，包含 defaults、interfacePolicy、routes、pinned。</td>
          </tr>
          <tr>
            <td>DNS Pin</td>
            <td><code>pinned</code> 字段</td>
            <td>域名→IP 列表；可在 UI 中刷新或清空。</td>
          </tr>
          <tr>
            <td>运行态缓存</td>
            <td>内存字典</td>
            <td>接口名→ifIndex 映射、最近 DNS 解析结果。</td>
          </tr>
          <tr>
            <td>快照</td>
            <td><code>snapshots/system-routes-YYYYMMDD-HHMMSS.json</code><br><code>snapshots/app-config-...</code></td>
            <td>Apply 前自动生成系统路由与工具配置快照。</td>
          </tr>
          <tr>
            <td>审计日志</td>
            <td><code>logs/rtmgr.log</code></td>
            <td>滚动分片，记录时间、用户、命令、返回码、结果。</td>
          </tr>
          <tr>
            <td>导入导出</td>
            <td>CSV / JSON</td>
            <td>字段与 UI 一致，含启用、目标、网关、接口、Metric、持久、分组、描述。</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section class="section-card">
      <h2>交互细节与状态反馈</h2>
      <ul class="list">
        <li><strong>批量操作：</strong>多选后工具栏展示批量启用/禁用/删除，执行后局部刷新表格。</li>
        <li><strong>过滤与搜索：</strong>搜索框支持目标、描述、分组关键字以及语法 <code>group:aliyun</code>。</li>
        <li><strong>内联编辑：</strong>双击单元格修改，Enter 保存、Esc 撤销；保存后行高亮并标记“未应用”。</li>
        <li><strong>安全护栏提示：</strong>尝试修改默认路由、本地子网时弹出阻断对话框并引导开启高级模式。</li>
        <li><strong>WireGuard 提醒：</strong>检测到 `/1` 路由时 UI 显示黄色警告，可点击查看设置。</li>
        <li><strong>权限自检：</strong>启动时检测管理员权限，不满足时禁用 Apply/回滚，并显示红色横幅。</li>
        <li><strong>日志查看：</strong>Diff 与验证弹窗内提供“复制命令”“打开日志文件”快捷入口。</li>
      </ul>
    </section>

    <section class="section-card">
      <h2>技术实现提示（PyQt6 映射）</h2>
      <table class="info-table">
        <thead>
          <tr>
            <th>原型控件</th>
            <th>PyQt6 建议组件</th>
            <th>备注</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>主窗口框架</td>
            <td><code>QMainWindow</code> + <code>QSplitter</code></td>
            <td>左右分栏：分组树 + 路由表格。</td>
          </tr>
          <tr>
            <td>分组树</td>
            <td><code>QTreeView</code> + <code>QStandardItemModel</code></td>
            <td>支持右键菜单、自定义状态图标。</td>
          </tr>
          <tr>
            <td>路由表格</td>
            <td><code>QTableView</code> + 自定义 <code>QAbstractTableModel</code></td>
            <td>支持勾选、下拉、内联编辑与状态列渲染。</td>
          </tr>
          <tr>
            <td>顶部工具栏</td>
            <td><code>QToolBar</code> + <code>QAction</code></td>
            <td>根据上下文动态启用/禁用操作。</td>
          </tr>
          <tr>
            <td>搜索框</td>
            <td><code>QLineEdit</code> + <code>QCompleter</code></td>
            <td>实现即时过滤与历史建议。</td>
          </tr>
          <tr>
            <td>弹窗</td>
            <td><code>QDialog</code> + <code>QFormLayout</code> / <code>QStackedWidget</code></td>
            <td>复用表单组件，支持多 Tab 设置。</td>
          </tr>
          <tr>
            <td>日志面板</td>
            <td><code>QPlainTextEdit</code>（只读）</td>
            <td>用于命令输出滚动显示。</td>
          </tr>
          <tr>
            <td>状态指示</td>
            <td><code>QLabel</code> + <code>QPixmap</code></td>
            <td>显示启用、失败、提醒等颜色标签。</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section class="section-card">
      <h2>测试与验收要点</h2>
      <ul class="list">
        <li>按设计文档 §15 场景执行：新增 → Apply → 验证 → 修改 Metric → 验证 → 删除 → 回滚。</li>
        <li>ifIndex 漂移：禁用/启用接口或重启 WireGuard 后，重新 Apply 仍成功。</li>
        <li>域名 Pin：首次解析后断网，使用 pinned IP 仍可成功 Apply。</li>
        <li>安全护栏：尝试修改默认路由时被阻止；开启高级模式后执行但记录审计。</li>
        <li>日志与快照：每次 Apply 前后都生成快照；失败后可回滚恢复。</li>
        <li>WireGuard 提示：检测 `/1` 路由时 UI 提示准确，并支持解除提醒。</li>
      </ul>
    </section>

    <section class="section-card">
      <h2>后续迭代建议</h2>
      <ul class="list">
        <li>支持 Dark Mode 与自定义列显示，改善长时间使用体验。</li>
        <li>集成命令执行耗时监控，超时自动重试或提示用户处理。</li>
        <li>提供脚本模式导出，可生成批量命令清单供离线执行。</li>
        <li>实现操作引导/教学模式，帮助新用户快速熟悉流程。</li>
      </ul>
    </section>

    <section class="section-card">
      <h2>参考资料</h2>
      <ul class="list">
        <li><code>docs/prototype/原型说明.md</code>：文字版详细说明。</li>
        <li><code>index.html</code>：交互原型示例。</li>
      </ul>
    </section>
  </main>

  <script type="module" src="assets/mermaid-init.js"></script>
</body>
</html>

