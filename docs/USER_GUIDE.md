# 路由管理工具 - 使用指南

## 目录

1. [快速开始](#快速开始)
2. [界面说明](#界面说明)
3. [基本操作](#基本操作)
4. [高级功能](#高级功能)
5. [常见问题](#常见问题)
6. [最佳实践](#最佳实践)

---

## 快速开始

### 安装与启动

1. 解压软件包到任意目录
2. **以管理员身份**运行 `RouteManager.exe`
3. 首次运行会自动创建默认 Profile `home.json`

### 第一次使用

1. 点击工具栏的 **"读取接口"** 按钮,获取当前网络接口信息
2. 点击 **"新增路由"** 按钮,添加第一条路由
3. 填写路由信息后保存
4. 点击 **"应用"** 按钮,将配置应用到系统

---

## 界面说明

### 主窗口布局

```
┌─────────────────────────────────────────────────────────┐
│ Profile: [home ▼] [管理] │ 新增 │ 读取接口 │ 应用 │ ... │
├──────────────┬──────────────────────────────────────────┤
│ 分组树        │                                          │
│ - All        │         路由表格                          │
│ - 未分组      │    (目标、网关、接口、描述等)              │
│ - aliyun     │                                          │
│ - office     │                                          │
├──────────────┴──────────────────────────────────────────┤
│ 状态栏: 接口信息 │ WireGuard │ 上次应用 │ Profile    │
└─────────────────────────────────────────────────────────┘
```

### 工具栏按钮

- **Profile 下拉**: 切换配置文件
- **管理**: Profile 管理(新建、导入、导出等)
- **新增路由**: 打开新增路由对话框
- **读取接口**: 刷新网络接口信息
- **应用**: 生成Diff并应用到系统
- **验证**: 验证路由是否生效
- **回滚**: 打开快照管理,可回滚到之前状态
- **导入/导出**: 批量导入导出路由
- **设置**: 全局设置(开发中)
- **帮助**: 显示帮助信息

### 分组树

- **All**: 显示所有路由
- **未分组**: 显示未分配分组的路由
- **自定义分组**: 按分组筛选路由

### 路由表格

显示所有路由的详细信息,支持:
- 排序(点击列头)
- 搜索(顶部搜索框)
- 多选(Ctrl/Shift + 点击)
- 编辑(双击或点击"编辑"按钮)

---

## 基本操作

### 1. 新增路由

1. 点击工具栏 **"新增路由"** 按钮
2. 填写路由信息:
   - **目标地址**: 支持以下格式
     - IPv4: `192.168.1.100`
     - CIDR: `192.168.1.0/24`
     - 域名: `git.example.com` (会自动解析)
   - **网关**: 下一跳网关IP
   - **接口**: 选择出接口(会自动填充网关)
   - **Metric**: 路由优先级(默认5)
   - **描述**: 路由用途说明(建议填写)
   - **分组**: 便于管理和筛选

3. 选项说明:
   - **持久化路由**: 勾选后路由重启不丢失(推荐)
   - **应用后验证**: 应用后自动验证路由
   - **固定解析**: 对域名有效,解析后固定IP

4. 点击 **"保存"** 完成

### 2. 编辑路由

1. 在路由表格中找到要编辑的路由
2. 点击行尾的 **"编辑"** 按钮
3. 修改信息后保存

### 3. 删除路由

1. 在路由表格中找到要删除的路由
2. 点击行尾的 **"删除"** 按钮
3. 确认删除

### 4. 应用路由

**重要**: 只有应用后,配置才会生效到系统!

1. 点击工具栏 **"应用"** 按钮
2. 系统自动:
   - 创建快照(用于回滚)
   - 生成Diff(显示要执行的变更)
3. 在Diff预览窗口:
   - 查看变更统计(新增/修改/删除)
   - 查看每条变更详情
   - 选择选项(自动验证、失败回滚)
4. 点击 **"执行"** 按钮开始应用
5. 等待执行完成,查看日志

**执行过程**:
- 先删除需要删除的路由
- 再修改需要修改的路由
- 最后添加新路由
- 任何步骤失败都会自动回滚

---

## 高级功能

### Profile 管理

Profile 是一组路由配置,可以快速切换不同场景。

#### 切换 Profile

1. 点击工具栏 **Profile 下拉框**
2. 选择要切换的 Profile
3. 选择:
   - **仅加载**: 不修改系统,仅编辑
   - **立即应用**: 加载并应用到系统

#### 新建 Profile

1. 点击 **"管理..."** 按钮
2. 点击 **"新建"** 按钮
3. 输入 Profile 名称
4. 在新 Profile 中添加路由

#### 导入/导出 Profile

- **导出**: 备份当前配置
  1. 点击 **"管理..."**
  2. 选择要导出的 Profile
  3. 点击 **"导出 Profile"**
  4. 选择保存位置

- **导入**: 恢复配置或导入他人分享
  1. 点击 **"管理..."**
  2. 点击 **"导入 Profile"**
  3. 选择JSON文件
  4. 输入新 Profile 名称

### 路由验证

验证路由是否真正生效。

1. 选择要验证的路由(或验证全部)
2. 点击工具栏 **"验证"** 按钮
3. (可选)勾选 **"执行 TraceRoute"** (会比较慢)
4. 等待验证完成
5. 查看结果:
   - 绿色 = 命中路由
   - 红色 = 未命中
   - 显示出接口、下一跳、延迟

### 快照与回滚

程序会在每次应用前自动创建快照。

#### 查看快照

1. 点击工具栏 **"回滚"** 按钮
2. 查看快照列表:
   - 时间
   - 类型(系统路由/配置文件)
   - 路由数量

#### 回滚到快照

1. 在快照列表中选择目标快照
2. 点击 **"回滚到此快照"**
3. 确认操作
4. (推荐)在回滚前创建备份快照

#### 手动创建快照

1. 点击 **"回滚"** 进入快照管理
2. 点击 **"创建快照"**
3. 快照会立即创建

#### 导出快照

1. 选择快照
2. 点击 **"导出快照"**
3. 保存为JSON文件

### 批量导入导出路由

#### 导出路由

1. 点击工具栏 **"导出"** 按钮
2. 选择格式:
   - **JSON**: 完整信息,可再次导入
   - **CSV**: 表格格式,便于Excel编辑
3. 选择保存位置

#### 导入路由

1. 点击工具栏 **"导入"** 按钮
2. 选择JSON或CSV文件
3. 选择导入策略:
   - **追加**: 添加到现有路由
   - **替换**: 清空并替换所有路由
4. 导入完成后记得 **"应用"**

### WireGuard 全隧道检测

如果检测到 WireGuard 全隧道模式:
- 界面会显示黄色提示
- 建议使用 /32 或精确 CIDR
- 避免使用过大的网段

---

## 常见问题

### Q1: 启动提示"需要管理员权限"?

**A**: 路由操作需要管理员权限。请:
1. 右键点击程序
2. 选择"以管理员身份运行"

### Q2: 应用后路由没有生效?

**A**: 可能原因:
1. 网关与接口不在同一网段 → 检查网关配置
2. 接口已断开 → 点击"读取接口"刷新
3. 存在冲突路由 → 查看Diff中的"删除"项
4. 使用"验证"功能确认

### Q3: ifIndex 变化导致路由失效?

**A**: 本工具不会硬编码 ifIndex:
- 保存时记录接口名称
- 应用时动态解析 ifIndex
- 即使重启或接口重新插拔也能正确应用

### Q4: 如何备份我的配置?

**A**: 多种方式:
1. 导出 Profile (推荐)
2. 导出路由为JSON
3. 手动备份 `profiles/` 目录

### Q5: 误操作了如何恢复?

**A**: 使用快照回滚:
1. 点击工具栏"回滚"
2. 选择操作前的快照
3. 回滚即可

### Q6: 能否在没有管理员权限的情况下编辑配置?

**A**: 可以:
- 编辑路由 → 不需要管理员权限
- 应用到系统 → 需要管理员权限
- 建议在有权限时应用

---

## 最佳实践

### 1. 命名规范

- **Profile**: 按场景命名,如 `home`、`office`、`vpn`
- **分组**: 按服务商或用途,如 `aliyun`、`office`、`devops`
- **描述**: 详细说明路由用途,便于日后维护

### 2. 定期维护

- 定期删除不用的路由
- 导出 Profile 作为备份
- 清理旧快照(保留最近5-10个)

### 3. 测试流程

新增重要路由时:
1. 先在测试 Profile 中添加
2. 应用并验证
3. 确认无误后导入到主 Profile

### 4. 团队协作

- 导出 Profile 分享给团队
- 统一路由规则
- 使用描述字段记录负责人和创建时间

### 5. 安全建议

- 不要轻易修改默认路由(0.0.0.0/0)
- 修改本地子网路由前三思
- 保持最近的快照以便回滚
- 重要操作前手动创建快照

### 6. 性能优化

- 不要添加过多重复路由
- 合理使用 CIDR 而不是大量 /32
- 定期清理禁用的路由
- Metric 值不要全部设置一样

---

## 技术支持

- 查看日志文件: `logs/rtmgr.log`
- 检查配置文件: `profiles/*.json`
- 查看快照: `snapshots/*.json`
- 参考设计文档: `docs/设计文档.md`

---

**版本**: v1.0  
**最后更新**: 2025-11-11

